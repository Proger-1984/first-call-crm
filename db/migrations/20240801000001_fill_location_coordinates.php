<?php

use Illuminate\Database\Capsule\Manager;

class FillLocationCoordinates
{
    public function getTableName(): string
    {
        return 'locations';
    }
    
    /**
     * Указывает, что эта миграция модифицирует существующую таблицу
     * и должна выполняться, даже если таблица уже существует
     */
    public function modifiesExistingTable(): bool
    {
        return true;
    }

    public function up()
    {
        // Включаем расширение PostGIS
        $this->enablePostGIS();
        
        // Координаты и границы для городов и их областей/регионов
        $locationCoordinates = [
            // Москва и Московская область
            'Москва' => [
                'center_lat' => 55.755826,
                'center_lng' => 37.6173,
                'bounds' => [
                    'north' => 56.8519, // Север Московской области
                    'south' => 54.7500, // Юг Московской области 
                    'east' => 39.3508,  // Восток Московской области
                    'west' => 35.3508   // Запад Московской области
                ]
            ],
            // Санкт-Петербург и Ленинградская область
            'Санкт-Петербург' => [
                'center_lat' => 59.9343,
                'center_lng' => 30.3351,
                'bounds' => [
                    'north' => 61.2786, // Север Ленинградской области
                    'south' => 58.3900, // Юг Ленинградской области
                    'east' => 34.8006,  // Восток Ленинградской области
                    'west' => 27.9085   // Запад Ленинградской области
                ]
            ],
            // Новосибирск и Новосибирская область
            'Новосибирск' => [
                'center_lat' => 55.0084,
                'center_lng' => 82.9357,
                'bounds' => [
                    'north' => 56.9051, // Север Новосибирской области
                    'south' => 53.5541, // Юг Новосибирской области
                    'east' => 84.9608,  // Восток Новосибирской области
                    'west' => 75.5982   // Запад Новосибирской области
                ]
            ],
            // Екатеринбург и Свердловская область
            'Екатеринбург' => [
                'center_lat' => 56.8389,
                'center_lng' => 60.6057,
                'bounds' => [
                    'north' => 61.9590, // Север Свердловской области
                    'south' => 56.0500, // Юг Свердловской области
                    'east' => 66.2174,  // Восток Свердловской области
                    'west' => 57.1463   // Запад Свердловской области
                ]
            ],
            // Казань и Республика Татарстан
            'Казань' => [
                'center_lat' => 55.7879,
                'center_lng' => 49.1233,
                'bounds' => [
                    'north' => 56.6733, // Север Татарстана
                    'south' => 53.9632, // Юг Татарстана
                    'east' => 54.2477,  // Восток Татарстана
                    'west' => 46.2002   // Запад Татарстана
                ]
            ],
            // Красноярск и Красноярский край
            'Красноярск' => [
                'center_lat' => 56.0184,
                'center_lng' => 92.8671,
                'bounds' => [
                    'north' => 81.2833, // Север Красноярского края (включая Таймыр)
                    'south' => 51.7403, // Юг Красноярского края
                    'east' => 113.5619, // Восток Красноярского края
                    'west' => 76.5382   // Запад Красноярского края
                ]
            ],
            // Нижний Новгород и Нижегородская область
            'Нижний Новгород' => [
                'center_lat' => 56.2965,
                'center_lng' => 43.9361,
                'bounds' => [
                    'north' => 58.0818, // Север Нижегородской области
                    'south' => 54.4216, // Юг Нижегородской области
                    'east' => 47.7194,  // Восток Нижегородской области
                    'west' => 41.7617   // Запад Нижегородской области
                ]
            ],
            // Челябинск и Челябинская область
            'Челябинск' => [
                'center_lat' => 55.1644,
                'center_lng' => 61.4368,
                'bounds' => [
                    'north' => 56.3705, // Север Челябинской области
                    'south' => 52.9947, // Юг Челябинской области
                    'east' => 63.2522,  // Восток Челябинской области
                    'west' => 57.1522   // Запад Челябинской области
                ]
            ],
            // Уфа и Республика Башкортостан
            'Уфа' => [
                'center_lat' => 54.7388,
                'center_lng' => 55.9721,
                'bounds' => [
                    'north' => 56.6766, // Север Башкортостана
                    'south' => 51.9570, // Юг Башкортостана
                    'east' => 60.3481,  // Восток Башкортостана
                    'west' => 53.1781   // Запад Башкортостана
                ]
            ],
            // Самара и Самарская область
            'Самара' => [
                'center_lat' => 53.1959,
                'center_lng' => 50.1010,
                'bounds' => [
                    'north' => 54.6957, // Север Самарской области
                    'south' => 51.7701, // Юг Самарской области
                    'east' => 52.5583,  // Восток Самарской области
                    'west' => 47.8512   // Запад Самарской области
                ]
            ],
            // Ростов-на-Дону и Ростовская область
            'Ростов-на-Дону' => [
                'center_lat' => 47.2357,
                'center_lng' => 39.7015,
                'bounds' => [
                    'north' => 50.2154, // Север Ростовской области
                    'south' => 45.8256, // Юг Ростовской области
                    'east' => 44.0709,  // Восток Ростовской области
                    'west' => 37.2089   // Запад Ростовской области
                ]
            ],
            // Краснодар и Краснодарский край
            'Краснодар' => [
                'center_lat' => 45.0448,
                'center_lng' => 38.9760,
                'bounds' => [
                    'north' => 46.8892, // Север Краснодарского края
                    'south' => 43.3815, // Юг Краснодарского края
                    'east' => 41.6754,  // Восток Краснодарского края
                    'west' => 36.5293   // Запад Краснодарского края
                ]
            ],
            // Омск и Омская область
            'Омск' => [
                'center_lat' => 54.9885,
                'center_lng' => 73.3242,
                'bounds' => [
                    'north' => 58.2670, // Север Омской области
                    'south' => 53.4381, // Юг Омской области
                    'east' => 76.2208,  // Восток Омской области
                    'west' => 70.3641   // Запад Омской области
                ]
            ],
            // Воронеж и Воронежская область
            'Воронеж' => [
                'center_lat' => 51.6720,
                'center_lng' => 39.1843,
                'bounds' => [
                    'north' => 52.8744, // Север Воронежской области
                    'south' => 49.5554, // Юг Воронежской области
                    'east' => 42.2695,  // Восток Воронежской области
                    'west' => 37.9243   // Запад Воронежской области
                ]
            ],
            // Пермь и Пермский край
            'Пермь' => [
                'center_lat' => 58.0105,
                'center_lng' => 56.2502,
                'bounds' => [
                    'north' => 61.6688, // Север Пермского края
                    'south' => 56.0608, // Юг Пермского края
                    'east' => 59.3964,  // Восток Пермского края
                    'west' => 51.7800   // Запад Пермского края
                ]
            ],
            // Волгоград и Волгоградская область
            'Волгоград' => [
                'center_lat' => 48.7080,
                'center_lng' => 44.5133,
                'bounds' => [
                    'north' => 51.1463, // Север Волгоградской области
                    'south' => 47.5519, // Юг Волгоградской области
                    'east' => 47.4013,  // Восток Волгоградской области
                    'west' => 41.7800   // Запад Волгоградской области
                ]
            ],
            // Саратов и Саратовская область
            'Саратов' => [
                'center_lat' => 51.5406,
                'center_lng' => 46.0086,
                'bounds' => [
                    'north' => 52.8005, // Север Саратовской области
                    'south' => 49.4379, // Юг Саратовской области
                    'east' => 50.8565,  // Восток Саратовской области
                    'west' => 42.4621   // Запад Саратовской области
                ]
            ],
            // Тюмень и Тюменская область (без АО)
            'Тюмень' => [
                'center_lat' => 57.1522,
                'center_lng' => 65.5272,
                'bounds' => [
                    'north' => 59.9500, // Север Тюменской области
                    'south' => 55.1200, // Юг Тюменской области
                    'east' => 75.2126,  // Восток Тюменской области
                    'west' => 64.0809   // Запад Тюменской области
                ]
            ],
            // Тверь и Тверская область
            'Тверь' => [
                'center_lat' => 56.8586,
                'center_lng' => 35.9176,
                'bounds' => [
                    'north' => 58.8740, // Север Тверской области
                    'south' => 55.6255, // Юг Тверской области
                    'east' => 38.2774,  // Восток Тверской области
                    'west' => 31.7466   // Запад Тверской области
                ]
            ]
        ];
        
        // Обновляем данные локаций
        foreach ($locationCoordinates as $city => $coords) {
            $lat = $coords['center_lat'];
            $lng = $coords['center_lng'];
            $bounds = $coords['bounds'];
            
            // Проверяем существование локации
            $location = Manager::table('locations')->where('city', $city)->first();
            if (!$location) {
                echo "Локация не найдена: {$city}\n";
                continue;
            }
            
            // Создаем WKT (Well-Known Text) для полигона границ
            // Формат: POLYGON((west south, east south, east north, west north, west south))
            $wktPolygon = sprintf(
                'POLYGON((%f %f, %f %f, %f %f, %f %f, %f %f))',
                $bounds['west'], $bounds['south'], // левый нижний угол
                $bounds['east'], $bounds['south'], // правый нижний угол
                $bounds['east'], $bounds['north'], // правый верхний угол
                $bounds['west'], $bounds['north'], // левый верхний угол
                $bounds['west'], $bounds['south']  // замыкаем полигон
            );
            
            // Обновляем запись
            try {
                Manager::statement(
                    "UPDATE locations SET 
                    center_lat = ?, 
                    center_lng = ?, 
                    bounds = ?, 
                    center_point = ST_SetSRID(ST_MakePoint(?, ?), 4326),
                    bounds_polygon = ST_SetSRID(ST_GeomFromText(?), 4326)
                    WHERE id = ?",
                    [
                        $lat, $lng, 
                        json_encode($bounds), 
                        $lng, $lat, // ST_MakePoint принимает (longitude, latitude)
                        $wktPolygon, 
                        $location->id
                    ]
                );
                echo "Обновлена локация: {$city} и регион\n";
            } catch (Exception $e) {
                echo "Ошибка при обновлении локации {$city}: " . $e->getMessage() . "\n";
            }
        }
    }

    public function down()
    {
        // Откат не требуется, так как мы только обновляем данные в существующих полях
    }
    
    /**
     * Включает расширение PostGIS в PostgreSQL, если оно еще не включено
     */
    private function enablePostGIS()
    {
        // Проверяем, существует ли расширение PostGIS
        $result = Manager::select("SELECT extname FROM pg_extension WHERE extname = 'postgis'");
        
        if (empty($result)) {
            // Включаем расширение PostGIS
            Manager::statement('CREATE EXTENSION IF NOT EXISTS postgis');
            Manager::statement('CREATE EXTENSION IF NOT EXISTS postgis_topology');
        }
    }
} 