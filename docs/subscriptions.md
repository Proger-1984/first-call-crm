# Работа с подписками

## Общие сведения

Система подписок позволяет пользователям получать доступ к данным определенных категорий и локаций на основе выбранных тарифных планов. Подписки имеют ограниченный срок действия и требуют оплаты (кроме демо-тарифа).

## Модели данных

### Tariff (Тариф)

Тарифы определяют длительность подписки и ее стоимость.

**Основные поля:**
- `id` - уникальный идентификатор
- `name` - название тарифа
- `code` - уникальный код тарифа
- `duration_hours` - длительность в часах
- `price` - базовая стоимость
- `description` - описание тарифа
- `is_active` - флаг активности тарифа

**Типы тарифов:**
- Демо-тариф (`code='demo'`) - бесплатный доступ на короткий период (3 часа)
- Платные тарифы - различной длительности:
  - Премиум 1 день (`code='premium_1'`) - 24 часа
  - Премиум 7 дней (`code='premium_7'`) - 168 часов
  - Премиум 31 день (`code='premium_31'`) - 744 часа

### TariffPrice (Цена тарифа)

Позволяет устанавливать разные цены для одного тарифа в зависимости от локации.

**Основные поля:**
- `id` - уникальный идентификатор
- `tariff_id` - ID тарифа
- `location_id` - ID локации
- `price` - стоимость для конкретной локации

### UserSubscription (Подписка пользователя)

Связывает пользователя, тариф, категорию и локацию.

**Основные поля:**
- `id` - уникальный идентификатор
- `user_id` - ID пользователя
- `tariff_id` - ID тарифа
- `category_id` - ID категории
- `location_id` - ID локации
- `price_paid` - фактическая оплаченная цена
- `start_date` - дата начала подписки
- `end_date` - дата окончания подписки
- `status` - статус подписки
- `payment_method` - метод оплаты
- `admin_notes` - примечания администратора
- `approved_by` - ID администратора, подтвердившего подписку
- `approved_at` - дата подтверждения подписки
- `is_enabled` - флаг активности подписки

**Статусы подписки:**
- `pending` - ожидает подтверждения администратора
- `active` - активная подписка
- `expired` - истекшая подписка
- `cancelled` - отмененная подписка

### SubscriptionHistory (История подписок)

Хранит историю действий с подписками.

**Основные поля:**
- `id` - уникальный идентификатор
- `user_id` - ID пользователя
- `subscription_id` - ID подписки (может быть null)
- `action` - тип действия
- `tariff_name` - название тарифа
- `category_name` - название категории
- `location_name` - название локации
- `price_paid` - оплаченная цена
- `action_date` - дата действия
- `notes` - примечания

**Типы действий:**
- `created` - создание подписки
- `activated` - активация подписки
- `renewed` - продление подписки
- `cancelled` - отмена подписки
- `expired` - истечение срока подписки
- `extend_requested` - запрос на продление подписки

## Процесс работы с подписками

### Создание подписки

1. Пользователь выбирает тариф, категорию и локацию
2. Система проверяет:
   - Существование и активность тарифа
   - Отсутствие активной подписки для выбранной категории и локации
   - Отсутствие ожидающей подтверждения подписки для выбранной категории и локации
   - Для демо-тарифа: не использовал ли пользователь демо-режим ранее
3. Система создает подписку со статусом `pending`
4. Если выбран демо-тариф, подписка автоматически активируется
5. Если выбран платный тариф, отправляется уведомление администратору и пользователю

### Запрос на продление подписки

1. Пользователь создает запрос на продление активной подписки
2. Пользователь выбирает:
   - Существующую подписку
   - Тариф для продления (может совпадать или отличаться от текущего)
   - Опциональные комментарии к заявке
3. Система проверяет:
   - Существование и активность подписки
   - Существование и активность выбранного тарифа
4. Система создает запись в истории подписок с типом `extend_requested`
5. Система отправляет уведомления:
   - Администратору с информацией о запросе на продление
   - Пользователю с подтверждением заявки и инструкциями по оплате

### Подтверждение подписки

1. Администратор рассматривает заявку на подписку
2. При подтверждении указывает:
   - Метод оплаты
   - Примечания (опционально)
   - Длительность (опционально, по умолчанию берется из тарифа)
3. Система активирует подписку:
   - Устанавливает статус `active`
   - Устанавливает даты начала и окончания
   - Записывает информацию об администраторе
4. Система создает запись в истории подписок
5. Отправляется уведомление пользователю об активации подписки

### Продление подписки

1. Администратор выбирает активную подписку для продления
2. Указывает:
   - Новую цену (опционально)
   - Метод оплаты
   - Примечания (опционально)
   - Длительность продления (опционально)
3. Система продлевает подписку, увеличивая дату окончания
4. Создается запись в истории подписок
5. Отправляется уведомление пользователю о продлении подписки

### Отмена подписки

1. Администратор выбирает подписку для отмены
2. Указывает причину отмены
3. Система меняет статус подписки на `cancelled`
4. Создается запись в истории подписок
5. Отправляется уведомление пользователю об отмене подписки

### Истечение срока подписки

1. Система регулярно проверяет подписки на истечение срока действия
2. Для истекших подписок:
   - Меняет статус на `expired`
   - Создает запись в истории
   - Отправляет уведомление пользователю

## Уведомления о подписках

Система отправляет уведомления через Telegram в следующих случаях:

1. Создание заявки на подписку (пользователю и администратору)
2. Активация демо-подписки (пользователю)
3. Подтверждение платной подписки (пользователю)
4. Создание запроса на продление подписки (пользователю и администратору)
5. Продление подписки (пользователю)
6. Отмена подписки (пользователю)
7. За 3 дня до истечения срока подписки (пользователю)
8. При истечении срока подписки (пользователю)

## API для работы с подписками

### Пользовательское API

- `GET /api/subscriptions` - получение списка активных подписок пользователя
- `POST /api/subscriptions` - создание заявки на подписку
- `POST /api/subscriptions/extend-request` - создание заявки на продление подписки

### Административное API

- `GET /api/admin/subscriptions` - получение списка всех подписок
- `GET /api/admin/subscriptions/pending` - получение списка ожидающих подтверждения подписок
- `POST /api/admin/subscriptions/{id}/activate` - активация подписки
- `POST /api/admin/subscriptions/{id}/extend` - продление подписки
- `POST /api/admin/subscriptions/{id}/cancel` - отмена подписки

## Фоновые задачи

- `NotifySubscriptionExpiringCommand` - отправка уведомлений о скором истечении подписок (за 3 дня)
- `NotifySubscriptionExpiredCommand` - отправка уведомлений об истекших подписках и изменение их статуса

## Проверка доступа к данным

Для проверки наличия подписки у пользователя используются следующие методы:

- `User::hasActiveSubscription(categoryId, locationId)` - проверка наличия активной подписки для конкретной категории и локации
- `User::hasAnyActiveSubscription()` - проверка наличия хотя бы одной активной подписки
- `User::hasActiveDemoSubscription()` - проверка наличия активной демо-подписки
- `UserSubscription::isActive()` - проверка активности конкретной подписки
- `UserSubscription::isExpired()` - проверка истечения срока подписки 