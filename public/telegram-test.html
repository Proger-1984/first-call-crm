<?php
// Загружаем переменные окружения
require_once __DIR__ . '/../vendor/autoload.php';
$dotenv = Dotenv\Dotenv::createImmutable(dirname(__DIR__));
$dotenv->load();

$botUsername = $_ENV['TELEGRAM_BOT_USERNAME'] ?? 'YOUR_BOT_USERNAME';
?>
<!DOCTYPE html>
<html>
<head>
    <title>Telegram Login Widget Test</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>Telegram Login Test</h1>
    
    <div id="telegram-login-container">
        <script async 
            src="https://telegram.org/js/telegram-widget.js" 
            data-telegram-login="<?php echo htmlspecialchars($botUsername); ?>"
            data-size="large"
            data-onauth="onTelegramAuth(user)"
            data-request-access="write">
        </script>
    </div>
    
    <h2>Информация для отладки:</h2>
    <p><strong>Bot Username:</strong> <?php echo htmlspecialchars($botUsername); ?></p>
    <p><strong>Current URL:</strong> <span id="current-url"></span></p>
    <p><strong>Widget Loaded:</strong> <span id="widget-loaded">Проверка...</span></p>
    
    <pre id="result">Ожидание авторизации...</pre>

    <script>
        // Показываем текущий URL
        document.getElementById('current-url').textContent = window.location.href;
        
        // Проверяем, загрузился ли виджет
        window.setTimeout(function() {
            var telegramLoginWidget = document.querySelector('[data-telegram-login]');
            if (telegramLoginWidget && telegramLoginWidget.querySelector('iframe')) {
                document.getElementById('widget-loaded').textContent = 'Да (виджет загружен)';
                document.getElementById('widget-loaded').style.color = 'green';
            } else {
                document.getElementById('widget-loaded').textContent = 'Нет (виджет не загрузился)';
                document.getElementById('widget-loaded').style.color = 'red';
            }
        }, 2000);
        
        function onTelegramAuth(user) {
            document.getElementById('result').innerText = JSON.stringify(user, null, 2);
            console.log('Telegram auth data:', user);
            
            // Для отладки можно отправить эти данные на сервер
            fetch('/api/v1/auth/telegram', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(user)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Server response:', data);
                document.getElementById('result').innerText += "\n\nОтвет сервера:\n" + JSON.stringify(data, null, 2);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('result').innerText += "\n\nОшибка:\n" + error.message;
            });
        }
    </script>
</body>
</html> 