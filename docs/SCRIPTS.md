# Документация по скриптам

В этом разделе содержится документация по скриптам и командам консоли, используемым в проекте.

## Список скриптов

| Скрипт | Описание |
|--------|----------|
| [TransferListingsCommand](#transferlistingscommand) | Перенос объявлений с удалённого сервера |
| [MetroStationsParserCommand](#metrostationsparsercommand) | Парсинг станций метро из API HeadHunter |
| [NotifySubscriptionExpiringCommand](#notifysubscriptionexpiringcommand) | Уведомления о скором окончании подписки |
| [NotifySubscriptionExpiredCommand](#notifysubscriptionexpiredcommand) | Уведомления об истечении подписки |
| [UpdateExpiredSubscriptionsCommand](#updateexpiredsubscriptionscommand) | Обновление статуса истекших подписок |

## Руководство по документированию скриптов

При документировании скриптов рекомендуется включать следующую информацию:

1. **Назначение скрипта** - краткое описание того, что делает скрипт
2. **Расположение файла** - путь к файлу скрипта в проекте
3. **Описание функциональности** - детальное описание всех действий скрипта
4. **Запуск скрипта** - команда для запуска скрипта
5. **Используемые таблицы в базе данных** - информация о таблицах, с которыми работает скрипт
6. **Логирование** - описание процесса логирования и тегов логов

При добавлении нового скрипта не забудьте обновить таблицу "Список скриптов" в этом файле.

---

## TransferListingsCommand

### Назначение
Скрипт переносит объявления недвижимости с удалённого MySQL сервера в локальную PostgreSQL базу данных. Работает в режиме демона — непрерывно опрашивает удалённую БД и синхронизирует новые объявления.

### Расположение файла
`src/Commands/TransferListingsCommand.php`

### Описание функциональности
Скрипт выполняет следующие действия:
1. Подключается к удалённой MySQL базе данных
2. Загружает паттерны комнат из локальной БД для определения `room_id`
3. Удаляет объявления старше 31 дня
4. В бесконечном цикле:
   - Получает новые объявления с удалённого сервера (batch по 100 записей)
   - Фильтрует по условиям (платные, статус 1 или 7, group_id=1)
   - Преобразует данные в формат локальной БД
   - Выполняет upsert в таблицу `listings`
   - Создаёт связи с метро в таблице `listing_metro`
   - Обновляет PostGIS point поля для геолокации

### Особенности обработки данных

#### Очистка URL
Для источника CIAN (source_id=3) удаляются параметры запроса из URL:
- Было: `https://www.cian.ru/rent/flat/326209530/?mlSearchSessionGuid=...`
- Стало: `https://www.cian.ru/rent/flat/326209530/`

#### Определение количества комнат
Тип комнат определяется по заголовку объявления и маппится на `room_id` из таблицы `rooms`:

| Паттерн в заголовке | room_id | Тип |
|---------------------|---------|-----|
| "студия" | 1 | Студия |
| "1-к.", "1-комн", "однокомн" | 2 | 1-комн |
| "2-к.", "2-комн", "двухкомн" | 3 | 2-комн |
| "3-к.", "3-комн", "трёхкомн" | 4 | 3-комн |
| "4-к.", "4-комн", "четырёхкомн" | 5 | 4-комн |
| "5-к.", "6-к.", "7-к.", "многокомн" | 6 | 5+ комн |
| "свободн" | 7 | Свободная планировка |

#### Время до метро
При создании связи объявления с метро генерируется случайное время пешком (1-15 минут).

### Конфигурация

| Параметр | Значение | Описание |
|----------|----------|----------|
| BATCH_SIZE | 100 | Количество записей за один запрос |
| SLEEP_INTERVAL | 2 сек | Пауза между итерациями |
| KEEP_DAYS | 31 | Хранить объявления за последние N дней |
| DEFAULT_LOCATION_ID | 1 | Москва и область |
| DEFAULT_CATEGORY_ID | 1 | Аренда жилая (Квартиры) |
| SOURCE_CIAN | 3 | ID источника CIAN в удалённой БД |

### Запуск скрипта

#### Ручной запуск
```bash
docker exec -it slim_php-cli php bin/app.php transfer-listings
```

#### Через Supervisor (рекомендуется)
Скрипт настроен для автоматического запуска через Supervisor:
- Запускается автоматически при старте контейнера (`autostart=true`)
- Перезапускается при падении (`autorestart=true`)
- Ожидает 10 секунд перед считанием процесса запущенным (`startsecs=10`)
- Максимум 3 попытки перезапуска (`startretries=3`)

Конфигурация: `docker/dev/php-cli/supervisor.d/transfer-listings.ini`

#### Управление через Supervisor
```bash
# Статус
docker exec slim_php-cli supervisorctl status transfer-listings

# Остановка
docker exec slim_php-cli supervisorctl stop transfer-listings

# Запуск
docker exec slim_php-cli supervisorctl start transfer-listings

# Перезапуск
docker exec slim_php-cli supervisorctl restart transfer-listings
```

### Таблицы в базе данных

#### Запись данных
- `listings` — основная таблица объявлений (upsert по `source_id` + `external_id`)
- `listing_metro` — связь объявлений со станциями метро

#### Чтение данных
- `rooms` — справочник типов комнат для определения `room_id`
- `metro_stations` — справочник станций метро для проверки существования

### Логирование
Скрипт использует сервис LogService для логирования с тегом `transfer-listings`:
- Запуск и подключение к удалённой БД
- Количество перенесённых объявлений
- Удаление старых объявлений
- Ошибки подключения и переподключение
- Критические ошибки

Файлы логов:
- Приложение: `logs/YYYY-MM-DD.log`
- Supervisor stdout: `/var/log/supervisor/transfer-listings.log`
- Supervisor stderr: `/var/log/supervisor/transfer-listings-error.log`

### Обработка ошибок
- При ошибке подключения к удалённой БД — автоматическое переподключение через 5 секунд
- Проверка соединения каждые 3 минуты
- При критической ошибке — завершение с кодом FAILURE, Supervisor перезапустит процесс

---

## MetroStationsParserCommand

### Назначение
Скрипт парсит информацию о станциях метро из API HeadHunter (hh.ru) и сохраняет данные в базу данных.

### Расположение файла
`src/Commands/MetroStationsParserCommand.php`

### Описание функциональности
Скрипт выполняет следующие действия:
1. Загружает список локаций (городов) из базы данных
2. Для каждой локации определяет ID города в API HeadHunter
3. Отправляет запрос к API HeadHunter для получения данных о станциях метро
4. Обрабатывает полученные данные: линии метро и станции
5. Сохраняет информацию о станциях метро в базу данных

### Запуск скрипта
```bash
php bin/console parse-metro-stations
```

### Запуск по расписанию
Скрипт запускается автоматически каждую ночь в 3:00 через cron. Запись в crontab выглядит следующим образом:

```bash
0 3 * * * /usr/bin/supervisorctl start parse-metro-stations
```

### Таблицы в базе данных
Скрипт работает с двумя таблицами:
- `locations` - таблица с локациями (городами)
- `metro_stations` - таблица для хранения информации о станциях метро

#### Структура таблицы metro_stations
| Поле | Описание |
|------|----------|
| location_id | ID локации (города) |
| name | Название станции метро |
| line | Название линии метро |
| color | Цвет линии в HEX-формате |
| lat | Широта расположения станции |
| lng | Долгота расположения станции |

### Поддерживаемые города
Скрипт поддерживает следующие города:
- Москва (ID: 1)
- Санкт-Петербург (ID: 2)
- Екатеринбург (ID: 3)
- Новосибирск (ID: 4)
- Нижний Новгород (ID: 66)
- Самара (ID: 78)
- Казань (ID: 88)

### Логирование
Скрипт использует сервис LogService для логирования следующих событий:
- Запуск и успешное завершение парсинга
- Количество загруженных локаций
- Парсинг станций метро для конкретного города
- Добавление станций метро в базу данных
- Предупреждения о существующих станциях
- Ошибки при выполнении скрипта

Файлы логов сохраняются с тегом `parse-metro-stations`.

## Скрипты для управления подписками

> **Общая информация:** Все тексты уведомлений для скриптов подписок находятся в сервисе `TelegramService` (`src/Services/TelegramService.php`). При необходимости изменить текст уведомления, нужно обращаться к этому сервису, а не к командам. Команды используют методы сервиса для отправки уведомлений.

### NotifySubscriptionExpiringCommand

#### Назначение
Скрипт отправляет уведомления пользователям, у которых скоро закончится срок действия подписки.

#### Расположение файла
`src/Commands/NotifySubscriptionExpiringCommand.php`

#### Описание функциональности
Для обычных тарифов уведомления отправляются:
- За 3 дня до окончания подписки
- За 1 день до окончания подписки

Для демо-тарифа (продолжительностью 3 часа) уведомления отправляются:
- За 1 час до окончания подписки
- За 15 минут до окончания подписки

В уведомлении содержится информация о подписке, дате окончания и инструкции по продлению.

> **Важно:** Все тексты уведомлений находятся в сервисе `TelegramService` (`src/Services/TelegramService.php`). Для изменения текста уведомлений необходимо редактировать этот класс, а не команду.

#### Запуск скрипта
```bash
php bin/console notify-subscription-expiring
```

#### Таблицы в базе данных
- `user_subscriptions` - таблица с подписками пользователей
- `tariffs` - таблица с тарифами
- `users` - таблица с пользователями

#### Логирование
Скрипт логирует все действия с тегом `subscription-expiring`.

### NotifySubscriptionExpiredCommand

#### Назначение
Скрипт отправляет уведомления пользователям, у которых закончился срок действия подписки в течение последних 24 часов.

#### Расположение файла
`src/Commands/NotifySubscriptionExpiredCommand.php`

#### Описание функциональности
Скрипт находит все подписки, срок действия которых истек за последние 24 часа, и отправляет уведомления пользователям через Telegram. В уведомлении содержится информация о подписке, дате окончания и инструкции по продлению.

> **Важно:** Все тексты уведомлений находятся в сервисе `TelegramService` (`src/Services/TelegramService.php`). Для изменения текста уведомлений необходимо редактировать этот класс, а не команду.

#### Запуск скрипта
```bash
php bin/console notify-subscription-expired
```

#### Таблицы в базе данных
- `user_subscriptions` - таблица с подписками пользователей
- `users` - таблица с пользователями

#### Логирование
Скрипт логирует все действия с тегом `subscription-expired`.

### UpdateExpiredSubscriptionsCommand

#### Назначение
Скрипт обновляет статус подписок, срок действия которых уже истек, но статус все еще 'active'.

#### Расположение файла
`src/Commands/UpdateExpiredSubscriptionsCommand.php`

#### Описание функциональности
Скрипт находит все активные подписки с истекшим сроком действия и меняет их статус на 'expired'. Для каждой обновленной подписки добавляется запись в историю подписок.

> **Примечание:** Этот скрипт сам не отправляет уведомления пользователям, он только обновляет статусы. Уведомления о завершении срока подписки отправляются отдельным скриптом `NotifySubscriptionExpiredCommand`.

#### Запуск скрипта
```bash
php bin/console update-expired-subscriptions
```

#### Таблицы в базе данных
- `user_subscriptions` - таблица с подписками пользователей
- `subscription_history` - таблица с историей подписок

#### Логирование
Скрипт логирует все действия с тегом `subscription-update`.

### Запуск по расписанию

Затем настройте запуск через cron:
```bash
# Обновление статуса истекших подписок (каждый час)
0 * * * * /usr/bin/supervisorctl start update-expired-subscriptions

# Уведомления о скором окончании подписки (каждые 5 минут для обработки демо-тарифов)
*/5 * * * * /usr/bin/supervisorctl start notify-subscription-expiring

# Уведомления об истечении подписки (ежедневно в 12:00)
0 12 * * * /usr/bin/supervisorctl start notify-subscription-expired
``` 