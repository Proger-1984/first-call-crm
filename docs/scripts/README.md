# Документация по скриптам

В этом разделе содержится документация по скриптам и командам консоли, используемым в проекте.

## Список скриптов

| Скрипт | Описание |
|--------|----------|
| [MetroStationsParserCommand](#metrostationsparsercommand) | Парсинг станций метро из API HeadHunter |
| [NotifySubscriptionExpiringCommand](#notifysubscriptionexpiringcommand) | Уведомления о скором окончании подписки |
| [NotifySubscriptionExpiredCommand](#notifysubscriptionexpiredcommand) | Уведомления об истечении подписки |
| [UpdateExpiredSubscriptionsCommand](#updateexpiredsubscriptionscommand) | Обновление статуса истекших подписок |

## Руководство по документированию скриптов

При документировании скриптов рекомендуется включать следующую информацию:

1. **Назначение скрипта** - краткое описание того, что делает скрипт
2. **Расположение файла** - путь к файлу скрипта в проекте
3. **Описание функциональности** - детальное описание всех действий скрипта
4. **Запуск скрипта** - команда для запуска скрипта
5. **Используемые таблицы в базе данных** - информация о таблицах, с которыми работает скрипт
6. **Логирование** - описание процесса логирования и тегов логов

При добавлении нового скрипта не забудьте обновить таблицу "Список скриптов" в этом файле.

## MetroStationsParserCommand

### Назначение
Скрипт парсит информацию о станциях метро из API HeadHunter (hh.ru) и сохраняет данные в базу данных.

### Расположение файла
`src/Commands/MetroStationsParserCommand.php`

### Описание функциональности
Скрипт выполняет следующие действия:
1. Загружает список локаций (городов) из базы данных
2. Для каждой локации определяет ID города в API HeadHunter
3. Отправляет запрос к API HeadHunter для получения данных о станциях метро
4. Обрабатывает полученные данные: линии метро и станции
5. Сохраняет информацию о станциях метро в базу данных

### Запуск скрипта
```bash
php bin/console parse-metro-stations
```

### Запуск по расписанию
Скрипт запускается автоматически каждую ночь в 3:00 через cron. Запись в crontab выглядит следующим образом:

```bash
0 3 * * * /usr/bin/supervisorctl start parse-metro-stations
```

### Таблицы в базе данных
Скрипт работает с двумя таблицами:
- `locations` - таблица с локациями (городами)
- `metro_stations` - таблица для хранения информации о станциях метро

#### Структура таблицы metro_stations
| Поле | Описание |
|------|----------|
| location_id | ID локации (города) |
| name | Название станции метро |
| line | Название линии метро |
| color | Цвет линии в HEX-формате |
| lat | Широта расположения станции |
| lng | Долгота расположения станции |

### Поддерживаемые города
Скрипт поддерживает следующие города:
- Москва (ID: 1)
- Санкт-Петербург (ID: 2)
- Екатеринбург (ID: 3)
- Новосибирск (ID: 4)
- Нижний Новгород (ID: 66)
- Самара (ID: 78)
- Казань (ID: 88)

### Логирование
Скрипт использует сервис LogService для логирования следующих событий:
- Запуск и успешное завершение парсинга
- Количество загруженных локаций
- Парсинг станций метро для конкретного города
- Добавление станций метро в базу данных
- Предупреждения о существующих станциях
- Ошибки при выполнении скрипта

Файлы логов сохраняются с тегом `parse-metro-stations`.

## Скрипты для управления подписками

### NotifySubscriptionExpiringCommand

#### Назначение
Скрипт отправляет уведомления пользователям, у которых скоро закончится срок действия подписки.

#### Расположение файла
`src/Commands/NotifySubscriptionExpiringCommand.php`

#### Описание функциональности
Для обычных тарифов уведомления отправляются:
- За 3 дня до окончания подписки
- За 1 день до окончания подписки

Для демо-тарифа (продолжительностью 3 часа) уведомления отправляются:
- За 1 час до окончания подписки
- За 15 минут до окончания подписки

В уведомлении содержится информация о подписке, дате окончания и инструкции по продлению.

#### Запуск скрипта
```bash
php bin/console notify-subscription-expiring
```

#### Таблицы в базе данных
- `user_subscriptions` - таблица с подписками пользователей
- `tariffs` - таблица с тарифами
- `users` - таблица с пользователями

#### Логирование
Скрипт логирует все действия с тегом `subscription-expiring`.

### NotifySubscriptionExpiredCommand

#### Назначение
Скрипт отправляет уведомления пользователям, у которых закончился срок действия подписки в течение последних 24 часов.

#### Расположение файла
`src/Commands/NotifySubscriptionExpiredCommand.php`

#### Описание функциональности
Скрипт находит все подписки, срок действия которых истек за последние 24 часа, и отправляет уведомления пользователям через Telegram. В уведомлении содержится информация о подписке, дате окончания и инструкции по продлению.

#### Запуск скрипта
```bash
php bin/console notify-subscription-expired
```

#### Таблицы в базе данных
- `user_subscriptions` - таблица с подписками пользователей
- `users` - таблица с пользователями

#### Логирование
Скрипт логирует все действия с тегом `subscription-expired`.

### UpdateExpiredSubscriptionsCommand

#### Назначение
Скрипт обновляет статус подписок, срок действия которых уже истек, но статус все еще 'active'.

#### Расположение файла
`src/Commands/UpdateExpiredSubscriptionsCommand.php`

#### Описание функциональности
Скрипт находит все активные подписки с истекшим сроком действия и меняет их статус на 'expired'. Для каждой обновленной подписки добавляется запись в историю подписок.

#### Запуск скрипта
```bash
php bin/console update-expired-subscriptions
```

#### Таблицы в базе данных
- `user_subscriptions` - таблица с подписками пользователей
- `subscription_history` - таблица с историей подписок

#### Логирование
Скрипт логирует все действия с тегом `subscription-update`.

### Запуск по расписанию

Затем настройте запуск через cron:
```bash
# Обновление статуса истекших подписок (каждый час)
0 * * * * /usr/bin/supervisorctl start update-expired-subscriptions

# Уведомления о скором окончании подписки (каждые 5 минут для обработки демо-тарифов)
*/5 * * * * /usr/bin/supervisorctl start notify-subscription-expiring

# Уведомления об истечении подписки (ежедневно в 12:00)
0 12 * * * /usr/bin/supervisorctl start notify-subscription-expired
``` 