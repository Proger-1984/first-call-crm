openapi: 3.0.0
info:
  title: First Call API
  version: 1.0.0
  description: |
    REST API для crm и мобильного приложения.
    
    ## Аутентификация
    API использует JWT токены для аутентификации. Получить токен можно через:
    - Авторизацию через Telegram (для crm)
    - Авторизацию через логин и пароль (для приложения)
    
    ## Общие принципы
    - Все запросы где требуется аунтификация должны содержать `Authorization: BearerAuth`
    - Все запросы должны содержать заголовок `Content-Type: application/json`
    - Все ответы возвращаются в формате JSON
    - В случае ошибки возвращается объект с полями `code`, `status`, `message` и `error`
    
    ## Коды ответов
    - 200: Успешный запрос
    - 400: Неверный формат запроса (неправильный формат JSON, отсутствие|пустые обязательные поля, неверный тип данных)
    - 401: Не авторизован
    - 403: Доступ запрещен
    - 404: Ресурс не найден
    - 422: Ошибка валидации (нарушение бизнес-правил, неверный формат данных, конфликт значений)
    - 500: Внутренняя ошибка сервера

tags:
  - name: Аутентификация
    description: Методы для авторизации и управления токенами
  - name: Пользователь
    description: Методы для работы с данными пользователя
  - name: Подписки
    description: Методы для управления подписками
  - name: Конфигурация
    description: Методы для получения конфигурационных данных
  - name: Администрирование
    description: Методы для администраторов системы

servers:
  - url: http://localhost:8080
    description: Локальный сервер разработки
  - url: https://rest-api.firstcall.com
    description: Продакшн сервер

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT токен доступа

  schemas:
    Error:
      type: object
      properties:
        code:
          type: integer
          description: HTTP код ошибки
          example: 400
        status:
          type: string
          description: Статус ответа
          example: error
        message:
          type: string
          description: Сообщение об ошибке
          example: Неверный формат данных
        error:
          type: string
          description: Код ошибки для программной обработки
          example: validation_error

    Source:
      type: object
      properties:
        id:
          type: integer
          description: ID источника
          example: 1
        name:
          type: string
          description: Название источника
          example: "Телефонный звонок"
        enabled:
          type: boolean
          description: Включен ли источник
          example: true

    Category:
      type: object
      properties:
        id:
          type: integer
          description: ID категории
          example: 1
        name:
          type: string
          description: Название категории
          example: "Важные звонки"
        enabled:
          type: boolean
          description: Включена ли категория
          example: true

    PhoneStatus:
      type: object
      required:
        - status
      properties:
        status:
          type: boolean
          description: Статус телефона (true - занят, false - свободен)
          example: true

    TelegramAuth:
      type: object
      required:
        - id
        - first_name
        - auth_date
        - hash
      properties:
        id:
          type: integer
          description: Telegram ID пользователя
          example: 123456789
        first_name:
          type: string
          description: Имя пользователя
          example: John
        last_name:
          type: string
          description: Фамилия пользователя
          example: Doe
        username:
          type: string
          description: Имя пользователя в Telegram
          example: johndoe
        photo_url:
          type: string
          description: URL фотографии пользователя
          example: https://t.me/i/userpic/320/123456789.jpg
        auth_date:
          type: integer
          description: Дата авторизации (Unix timestamp)
          example: 1616432400
        hash:
          type: string
          description: Хеш для проверки данных
          example: 1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef

    LoginCredentials:
      type: object
      required:
        - login
        - password
      properties:
        login:
          type: string
          description: Логин
          example: "111"
        password:
          type: string
          description: Пароль
          example: "password123"

    UserSettings:
      type: object
      properties:
        settings:
          type: object
          properties:
            log_events:
              type: boolean
              description: Включено ли логирование событий
              example: false
            auto_call:
              type: boolean
              description: Включен ли автоматический звонок
              example: false
            telegram_notifications:
              type: boolean
              description: Включены ли уведомления в Telegram
              example: false
        sources:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                description: ID источника
                example: 1
              name:
                type: string
                description: Название источника
                example: "Авито"
              enabled:
                type: boolean
                description: Включен ли источник
                example: true
        active_subscriptions:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                description: ID подписки
                example: 3
              name:
                type: string
                description: Название подписки
                example: "Аренда. Жилая|Москва, Московская область"
              enabled:
                type: boolean
                description: Включена ли подписка
                example: true

    AuthResponse:
      type: object
      properties:
        code:
          type: integer
          description: HTTP код ответа
          example: 200
        status:
          type: string
          description: Статус ответа
          example: success
        access_token:
          type: string
          description: JWT токен доступа
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        refresh_token:
          type: string
          description: Токен для обновления доступа
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        expires_in:
          type: integer
          description: Время жизни токена в секундах
          example: 3600

    SubscriptionRequest:
      type: object
      required:
        - tariff_id
        - category_ids
        - location_id
      properties:
        tariff_id:
          type: integer
          description: ID тарифа
          example: 1
        category_ids:
          type: array
          description: Массив ID категорий
          items:
            type: integer
          example: [1, 2]
        location_id:
          type: integer
          description: ID локации
          example: 1

paths:
  /api/v1/auth/telegram:
    post:
      summary: Авторизация через Telegram
      description: |
        Авторизация пользователя через Telegram.
        
        Для авторизации необходимо передать данные, полученные от Telegram Login Widget.
        Все данные должны быть подписаны с помощью секретного ключа бота.
        
        При успешной авторизации:
        - В теле ответа возвращается access_token
        - В куках устанавливается refresh_token
      tags:
        - Аутентификация
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TelegramAuth'
      responses:
        '200':
          description: Успешная авторизация
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    description: HTTP код ответа
                    example: 200
                  status:
                    type: string
                    description: Статус ответа
                    example: success
                  message:
                    type: string
                    description: Сообщение об успешной авторизации
                    example: "Успешная авторизация через Telegram"
                  access_token:
                    type: string
                    description: JWT токен доступа
                    example: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
          headers:
            Set-Cookie:
              schema:
                type: string
                example: "refreshToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; path=/api/v1/auth; domain=.example.com; max-age=2592000; expires=Wed, 06 May 2024 12:00:00 GMT; HttpOnly; Secure; SameSite=None"
        '400':
          description: |
            Неверный формат запроса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 400
                status: error
                message: Неверный формат запроса
                error: validation_error
        '422':
          description: Ошибка валидации данных
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 422
                status: error
                message: Ошибка авторизации через Telegram
                error: validation_error
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 500
                status: error
                message: Внутренняя ошибка сервера
                error: internal_error

  /api/v1/auth/login:
    post:
      summary: Авторизация через приложение
      description: |
        Авторизация пользователя через логин и пароль.
        
        После успешной авторизации возвращается:
        - access_token - JWT токен для доступа к API
        - refresh_token - токен для обновления access_token
        - expires_in - время жизни токена в секундах
      tags:
        - Аутентификация
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginCredentials'
      responses:
        '200':
          description: Успешная авторизация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: |
            Неверный формат запроса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 400
                status: error
                message: Неверный формат запроса
                error: validation_error
        '401':
          description: |
            Ошибка авторизации
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 401
                status: error
                message: Неверный логин или пароль
                error: invalid_credentials
        '403':
          description: |
            Доступ запрещен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 403
                status: error
                message: "Доступ запрещен: подписка истекла"
                error: subscription_expired
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 500
                status: error
                message: Внутренняя ошибка сервера
                error: internal_error

  /api/v1/auth/refresh:
    get:
      summary: Обновление токена access_token
      description: |
        Обновление JWT токена доступа с помощью refresh токена.
        
        Refresh токен должен быть передан в заголовке Authorization.
      tags:
        - Аутентификация
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Токен успешно обновлен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: "Токен отсутствует или недействителен"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                token_not_found:
                  value:
                    code: 401
                    status: error
                    message: "Refresh token not found"
                    error: "token_not_found"
                token_expired:
                  value:
                    code: 401
                    status: error
                    message: "Refresh token expired"
                    error: "token_expired"
        '500':
          description: "Внутренняя ошибка сервера"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 500
                status: error
                message: "Внутренняя ошибка сервера"
                error: "internal_error"

  /api/v1/auth/logout:
    get:
      summary: Выход из системы
      description: |
        Выход пользователя из системы.

        Access токен должен быть передан в заголовке Authorization.

        Текущий токен будет признан недействительным.
      tags:
        - Аутентификация
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Успешный выход
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Успешный выход из системы
        '401':
          description: Токен отсутствует
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 401
                status: error
                message: Access token not found
                error: token_not_found
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 500
                status: error
                message: Внутренняя ошибка сервера
                error: internal_error

  /api/v1/config/telegram-bot-username:
    get:
      summary: Получение имени бота
      description: Получение имени бота Telegram для авторизации
      tags:
        - Конфигурация
      responses:
        '200':
          description: Имя бота получено
          content:
            application/json:
              schema:
                type: object
                properties:
                  username:
                    type: string
                    description: Имя бота в Telegram
                    example: "firstcall_bot"
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 500
                status: error
                message: Внутренняя ошибка сервера
                error: internal_error

  /api/v1/me/settings:
    get:
      summary: Получение настроек пользователя
      description: |
        Получение всех настроек пользователя.
        
        Access токен должен быть передан в заголовке Authorization.
        
        В ответе возвращаются:
        - Настройки пользователя (логирование, автозвонок, уведомления, статус телефона)
        - Список источников с их статусами
        - Список активных подписок
      tags:
        - Пользователь
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Настройки получены
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  status:
                    type: string
                    example: success
                  data:
                    $ref: '#/components/schemas/UserSettings'
              example:
                code: 200
                status: success
                data:
                  settings:
                    log_events: false
                    auto_call: false
                    telegram_notifications: false
                  sources:
                    - id: 1
                      name: "Авито"
                      enabled: true
                    - id: 2
                      name: "Яндекс.Н"
                      enabled: true
                    - id: 3
                      name: "Циан"
                      enabled: true
                    - id: 4
                      name: "ЮЛА"
                      enabled: true
                  active_subscriptions:
                    - id: 3
                      name: "Аренда. Жилая|Москва, Московская область"
                      enabled: true
                    - id: 2
                      name: "Продажа. Жилая|Москва, Московская область"
                      enabled: true
        '401':
          description: "Токен отсутствует или недействителен"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                token_not_found:
                  value:
                    code: 401
                    status: error
                    message: "Access token not found"
                    error: "token_not_found"
                token_expired:
                  value:
                    code: 401
                    status: error
                    message: "Access token expired"
                    error: "token_expired"
        '500':
          description: "Внутренняя ошибка сервера"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 500
                status: error
                message: "Внутренняя ошибка сервера"
                error: "internal_error"

    put:
      summary: Обновление настроек пользователя
      description: |
        Обновление настроек пользователя.

        Access токен должен быть передан в заголовке Authorization.
        
        Можно обновить как отдельные настройки, так и все сразу.
        
        При обновлении источников необходимо передать все источники, даже если их статус не меняется.
      tags:
        - Пользователь
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserSettings'
            example:
              settings:
                log_events: false
                auto_call: false
                telegram_notifications: false
              sources:
                - id: 1
                  name: "Авито"
                  enabled: true
                - id: 2
                  name: "Яндекс.Н"
                  enabled: true
                - id: 3
                  name: "Циан"
                  enabled: true
                - id: 4
                  name: "ЮЛА"
                  enabled: true
              active_subscriptions:
                - id: 3
                  name: "Аренда. Жилая|Москва, Московская область"
                  enabled: true
                - id: 2
                  name: "Продажа. Жилая|Москва, Московская область"
                  enabled: true
      responses:
        '200':
          description: Настройки обновлены
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: "Настройки успешно обновлены"
                  data:
                    $ref: '#/components/schemas/UserSettings'
        '400':
          description: "Неверный формат запроса"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_json:
                  value:
                    code: 400
                    status: error
                    message: "Неверный формат запроса"
                    error: "validation_error"
        '401':
          description: "Токен отсутствует или недействителен"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                token_not_found:
                  value:
                    code: 401
                    status: error
                    message: "Access token not found"
                    error: "token_not_found"
                token_expired:
                  value:
                    code: 401
                    status: error
                    message: "Access token expired"
                    error: "token_expired"
        '500':
          description: "Внутренняя ошибка сервера"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 500
                status: error
                message: "Внутренняя ошибка сервера"
                error: "internal_error"

  /api/v1/me/phone-status:
    put:
      summary: Обновить статус телефона
      description: |
        Обновляет статус телефона пользователя (занят/свободен).
        
        Этот статус может использоваться для маршрутизации звонков и отображения
        текущего состояния пользователя в интерфейсе.
      tags:
        - Пользователь
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PhoneStatus'
      responses:
        '200':
          description: Статус телефона успешно обновлен
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Статус телефона успешно обновлен
        '400':
          description: "Неверный формат запроса"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_json:
                  value:
                    code: 400
                    status: error
                    message: "Неверный формат запроса. Данные должны быть переданы в формате JSON"
                    error: "validation_error"
                missing_status:
                  value:
                    code: 400
                    status: error
                    message: "Неверный формат запроса. Отсутствует обязательное поле status"
                    error: "validation_error"
                invalid_status_type:
                  value:
                    code: 400
                    status: error
                    message: "Неверный формат запроса. Поле status должно быть boolean"
                    error: "validation_error"
        '401':
          description: "Токен отсутствует или недействителен"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                token_not_found:
                  value:
                    code: 401
                    status: error
                    message: "Access token not found"
                    error: "token_not_found"
                token_expired:
                  value:
                    code: 401
                    status: error
                    message: "Access token expired"
                    error: "token_expired"
        '500':
          description: "Внутренняя ошибка сервера"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 500
                status: error
                message: "Внутренняя ошибка сервера"
                error: "internal_error"

  /api/v1/admin/subscriptions/activate:
    post:
      summary: Массовая активация подписок (Admin)
      description: |
        Активирует несколько подписок одновременно.
        
        Этот метод доступен только для администраторов.
        Позволяет активировать несколько подписок за один запрос.
        
        В случае успешной активации всех подписок возвращается код 200.
        Если некоторые подписки были активированы успешно, а некоторые с ошибками,
        возвращается код 207 (Multi-Status) с детальной информацией о результатах.
        Если ни одна подписка не была активирована, возвращается код 400.
      tags:
        - Администрирование
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - subscription_ids
                - payment_method
              properties:
                subscription_ids:
                  type: array
                  description: Массив ID подписок для активации
                  items:
                    type: integer
                  example: [1, 2, 3]
                payment_method:
                  type: string
                  description: Метод оплаты
                  example: "cash"
                notes:
                  type: string
                  description: Дополнительные заметки
                  example: "Оплата наличными"
                duration_hours:
                  type: integer
                  description: Продолжительность подписки в часах
                  example: 720
      responses:
        '200':
          description: Все подписки успешно активированы
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Все подписки успешно активированы
                  data:
                    type: object
                    properties:
                      activated_subscriptions:
                        type: array
                        items:
                          type: object
        '207':
          description: Некоторые подписки активированы успешно, некоторые с ошибками
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 207
                  status:
                    type: string
                    example: partial_success
                  message:
                    type: string
                    example: Некоторые подписки активированы успешно, некоторые с ошибками
        '400':
          description: Неверный формат запроса или ни одна подписка не была активирована
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                validation_error:
                  value:
                    code: 400
                    status: error
                    message: Отсутствует или неверный формат subscription_ids
                    error: validation_error
                payment_method_missing:
                  value:
                    code: 400
                    status: error
                    message: Отсутствует обязательное поле payment_method
                    error: validation_error
        '401':
          description: Токен отсутствует или недействителен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Доступ запрещен (не администратор)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 403
                status: error
                message: У вас нет доступа к этому ресурсу
                error: access_denied
        '404':
          description: Запрашиваемые подписки не найдены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 404
                status: error
                message: Некоторые подписки не найдены
                error: not_found
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/subscriptions:
    post:
      summary: Создание заявки на подписку
      description: |
        Создает заявку на подписку для пользователя.
        
        Пользователь может создать несколько подписок для разных категорий одновременно.
        Для демо-тарифа доступна только одна категория. При выборе платного тарифа
        и наличии активной демо-подписки, демо-подписка автоматически отменяется.
        
        Требуется аутентификация с помощью JWT токена.
      tags:
        - Подписки
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscriptionRequest'
            examples:
              singleCategory:
                summary: Запрос с одной категорией
                value:
                  tariff_id: 1
                  category_ids: [1]
                  location_id: 1
              multipleCategories:
                summary: Запрос с несколькими категориями
                value:
                  tariff_id: 2
                  category_ids: [1, 2]
                  location_id: 1
      responses:
        '200':
          description: Заявка на подписку успешно создана
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    description: HTTP код ответа
                    example: 200
                  status:
                    type: string
                    description: Статус ответа
                    example: success
                  message:
                    type: string
                    description: Сообщение о результате операции
                    example: "Заявки на подписку успешно созданы"
        '400':
          description: Неверный формат запроса или бизнес-ограничения
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                validation_error:
                  value:
                    code: 400
                    status: error
                    message: "Неверный формат запроса. Отсутствует или неверный формат tariff_id"
                    error: "validation_error"
                demo_limit:
                  value:
                    code: 400
                    status: error
                    message: "Для демо-тарифа доступна только одна категория"
                    error: "validation_error"
                already_used_trial:
                  value:
                    code: 400
                    status: error
                    message: "Вы уже использовали демо-тариф ранее"
                    error: "validation_error"
                subscription_exists:
                  value:
                    code: 400
                    status: error
                    message: "Не удалось создать подписки. Возможно, они уже существуют"
                    error: "operation_failed"
        '401':
          description: Токен отсутствует или недействителен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                token_not_found:
                  value:
                    code: 401
                    status: error
                    message: "Access token not found"
                    error: "token_not_found"
                token_expired:
                  value:
                    code: 401
                    status: error
                    message: "Access token expired"
                    error: "token_expired"
        '404':
          description: Запрашиваемый ресурс не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                tariff_not_found:
                  value:
                    code: 404
                    status: error
                    message: "Указанный тариф не найден"
                    error: "not_found"
                location_not_found:
                  value:
                    code: 404
                    status: error
                    message: "Указанная локация не найдена"
                    error: "not_found"
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 500
                status: error
                message: Внутренняя ошибка сервера
                error: internal_error 