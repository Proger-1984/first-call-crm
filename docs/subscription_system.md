# Документация по системе управления подписками

## 1. Общая схема работы подписок

### 1.1 Основные типы тарифов
1. **Демо** - бесплатный тариф на 3 часа для ознакомления
2. **Премиум-тарифы**:
   * **Премиум 1 день** (код: `premium_1`) - 24 часа
   * **Премиум 7 дней** (код: `premium_7`) - 168 часов
   * **Премиум 31 день** (код: `premium_31`) - 744 часа

### 1.2 Статусы подписок
* **pending** - ожидает подтверждения администратором
* **active** - активная подписка
* **expired** - истекшая подписка
* **cancelled** - отмененная подписка

### 1.3 Дополнительные параметры
* **is_enabled** - флаг временного включения/отключения подписки
* **is_trial_used** - флаг использования демо-тарифа пользователем

## 2. Пользовательские сценарии

### 2.1 Пользователь зарегистрировался впервые

**Исходное состояние**:
* Новый пользователь
* `is_trial_used = false`

**Процесс для демо-подписки**:
1. Пользователь выбирает демо-тариф, категорию и локацию
2. Система проверяет, что `is_trial_used = false`
3. Система создает подписку в статусе **active**
4. Система устанавливает:
   * `start_date = текущая дата`
   * `end_date = текущая дата + 3 часа`
   * `is_trial_used = true` (для пользователя)
5. Пользователь получает немедленный доступ к контенту

**Процесс для премиум-подписки**:
1. Пользователь выбирает премиум-тариф, категории и локацию
2. Система устанавливает `is_trial_used = true` (даже если пользователь не использовал демо)
3. Система создает подписку в статусе **pending**
4. Администратор получает уведомление о новой заявке
5. Администратор проверяет оплату и активирует подписку
6. Система меняет статус на **active** и устанавливает даты

### 2.2 Пользователь хочет оформить платную подписку, но демо ещё активна

**Исходное состояние**:
* Пользователь имеет активную демо-подписку (любая категория/локация)

**Процесс**:
1. Пользователь запрашивает премиум-подписку
2. Система автоматически отменяет все существующие демо-подписки
   * Статус демо меняется на **cancelled**
   * В историю записывается: "Автоматическая отмена при переходе на платный тариф"
3. Система создает новую подписку в статусе **pending**
4. Администратор проверяет оплату и активирует новую подписку
5. Пользователь получает доступ к контенту по активированной премиум-подписке

### 2.3 Пользователь хочет оформить подписку, но у него есть такая же активная подписка

**Исходное состояние**:
* У пользователя есть активная подписка на категорию X, локацию Y с тарифом Z

**Процесс**:
1. Пользователь пытается создать подписку на ту же категорию X, локацию Y, тариф Z
2. Система проверяет наличие дублирующей подписки
3. Система отклоняет запрос с сообщением: "У вас уже есть активная подписка для этой категории и локации"
4. Пользователю предлагается продлить существующую подписку (см. раздел 2.5)

### 2.4 Пользователь хочет сменить тариф с 7 дней на 30 дней

**Исходное состояние**:
* У пользователя есть активная подписка на 7 дней
* Остаётся 3 дня до истечения

**Процесс**:
1. Пользователь запрашивает новую подписку на 30 дней (та же категория и локация)
2. Администратор использует API для изменения тарифа:
   ```
   PATCH /api/v1/admin/subscriptions/{id}/change-tariff
   {
     "tariff_id": [ID тарифа на 30 дней],
     "payment_method": "card",
     "notes": "Переход с тарифа 7 дней"
   }
   ```
3. Система:
   * Сохраняет оставшееся время (3 дня = 72 часа)
   * Устанавливает новую дату окончания (текущая дата + 30 дней + 3 дня)
   * Записывает действие в историю с типом "tariff_changed"
4. Пользователь получает уведомление об успешном изменении тарифа

### 2.5 Пользователь хочет продлить подписку

#### 2.5.1 Продление активной подписки

**Исходное состояние**:
* У пользователя есть активная подписка
* Остаётся несколько дней до истечения

**Процесс**:
1. Пользователь запрашивает продление подписки
2. Система создает заявку на продление 
3. Администратор проверяет оплату и использует API для продления:
   ```
   POST /api/v1/admin/subscriptions/{id}/extend
   {
     "payment_method": "card",
     "notes": "Продление активной подписки",
     "duration_hours": 720
   }
   ```
4. Система:
   * Добавляет указанную продолжительность к существующей дате окончания
   * Записывает действие в историю с типом "extended"
5. Пользователь получает уведомление об успешном продлении

#### 2.5.2 Возобновление истекшей подписки

**Исходное состояние**:
* У пользователя есть подписка в статусе **expired**

**Процесс**:
1. Пользователь запрашивает продление истекшей подписки
2. Система создает заявку на продление
3. Администратор проверяет оплату и использует API для продления:
   ```
   POST /api/v1/admin/subscriptions/{id}/extend
   {
     "payment_method": "card",
     "notes": "Возобновление истекшей подписки",
     "duration_hours": 720
   }
   ```
4. Система:
   * Меняет статус с **expired** на **active**
   * Устанавливает `start_date = текущая дата`
   * Устанавливает `end_date = текущая дата + duration_hours`
   * Записывает действие в историю с типом "extended"
5. Пользователь получает уведомление об успешном возобновлении

### 2.6 Пользователь хочет временно отключить подписку

**Процесс**:
1. Пользователь выбирает активную подписку и нажимает кнопку отключения
2. Система вызывает метод `toggleEnabled(false)`
3. Подписка остаётся в статусе **active**, но устанавливается `is_enabled = false`
4. Доступ к контенту по этой подписке временно приостанавливается
5. Время действия подписки продолжает истекать
6. Пользователь может в любое время включить подписку обратно, вызвав `toggleEnabled(true)`

## 3. Административные сценарии

### 3.1 Обработка заявок на подписки

**Процесс**:
1. Администратор просматривает список подписок в статусе **pending**
2. Для каждой подписки администратор:
   * Проверяет информацию об оплате
   * Проверяет выбранный тариф, категорию и локацию
3. Если оплата подтверждена, администратор активирует подписку:
   ```
   POST /api/v1/admin/subscriptions/{id}/activate
   {
     "payment_method": "card",
     "notes": "Подтверждено по чеку #12345",
     "duration_hours": 720
   }
   ```
4. Система:
   * Меняет статус на **active**
   * Устанавливает даты начала и окончания
   * Записывает действие в историю с типом "activated"
   * Устанавливает флаг `is_trial_used = true` для пользователя (если еще не установлен)
   * Отменяет все активные демо-подписки этого пользователя
5. Пользователь получает уведомление об активации подписки

### 3.2 Пакетная активация подписок

**Процесс**:
1. Администратор выбирает несколько подписок в статусе **pending**
2. Администратор вызывает API для массовой активации:
   ```
   POST /api/v1/admin/subscriptions/activate
   {
     "subscription_id": 5,
     "payment_method": "card",
     "notes": "Групповая активация",
     "duration_hours": 720
   }
   ```
3. Система:
   * Группирует подписки по пользователям
   * Для каждого пользователя, у которого есть премиум-подписки:
     * Устанавливает флаг `is_trial_used = true` (если еще не установлен)
     * Отменяет все активные демо-подписки
   * Активирует все указанные подписки
4. Система возвращает результат с информацией об успешных и неуспешных активациях
5. Пользователи получают уведомления об активации подписок

### 3.3 Создание подписки для пользователя

**Процесс**:
1. Администратор выбирает пользователя и параметры подписки
2. Администратор вызывает API для создания подписки:
   ```
   POST /api/v1/admin/subscriptions
   {
     "user_id": 123,
     "tariff_id": 2,
     "category_id": 3,
     "location_id": 4,
     "activate": true,
     "payment_method": "Создано администратором",
     "notes": "Подарочная подписка"
   }
   ```
3. Система:
   * Создает подписку
   * Если выбран премиум-тариф, устанавливает `is_trial_used = true` для пользователя и отменяет активные демо-подписки
   * Если параметр `activate = true`, сразу активирует подписку
   * Записывает действие в историю
4. Пользователь получает уведомление о созданной подписке

### 3.4 Изменение тарифа подписки

**Процесс**:
1. Администратор находит активную подписку
2. Администратор вызывает API для изменения тарифа:
   ```
   PATCH /api/v1/admin/subscriptions/{id}/change-tariff
   {
     "tariff_id": 4,
     "payment_method": "Доплата наличными",
     "notes": "Апгрейд тарифа по запросу пользователя"
   }
   ```
3. Система:
   * Сохраняет оставшееся время от старого тарифа
   * Устанавливает новую дату окончания с учетом нового тарифа
   * Записывает действие в историю с типом "tariff_changed"
4. Пользователь получает уведомление об изменении тарифа

### 3.5 Отмена подписки

**Процесс**:
1. Администратор находит подписку для отмены
2. Администратор вызывает API для отмены:
   ```
   DELETE /api/v1/admin/subscriptions/{id}
   {
     "reason": "Отмена по запросу пользователя"
   }
   ```
3. Система:
   * Меняет статус на **cancelled**
   * Записывает действие в историю с типом "cancelled"
4. Пользователь получает уведомление об отмене подписки

## 4. Система автоматических уведомлений

### 4.1 Уведомления для пользователей

| Событие | Условие отправки | Содержание |
|---------|------------------|------------|
| Создание демо-подписки | При автоматической активации | "Ваша демо-подписка активирована. Доступ открыт до {end_date}" |
| Создание премиум-подписки | При подтверждении администратором | "Ваша подписка успешно активирована. Доступ открыт до {end_date}" |
| Скорое истечение подписки | Зависит от типа тарифа:<br>- Демо: за 30 минут<br>- Премиум 1: за 6 часов<br>- Премиум 7: за 24 часа<br>- Премиум 30: за 72 часа | "Ваша подписка истекает {end_date}. Продлите подписку, чтобы сохранить доступ" |
| Истечение подписки | При переходе в статус **expired** | "Ваша подписка закончилась. Для возобновления доступа продлите подписку" |
| Изменение тарифа | При обновлении тарифа | "Тариф вашей подписки изменен на {tariff_name}. Новая дата окончания: {end_date}" |
| Отмена подписки | При переходе в статус **cancelled** | "Ваша подписка отменена. Причина: {reason}" |

### 4.2 Уведомления для администраторов

| Событие | Условие отправки | Содержание |
|---------|------------------|------------|
| Новая заявка на подписку | При создании подписки в статусе **pending** | "Новая заявка на подписку #{id} от пользователя {user_name}" |
| Массовое истечение подписок | При истечении более 10 подписок за сутки | "Внимание: За последние 24 часа истекло {count} подписок" |

## 5. Автоматизированные процессы

### 5.1 Проверка истекших подписок

**Процесс**:
1. Консольная команда `CheckExpiredSubscriptionsCommand` запускается по расписанию (ежечасно)
2. Команда находит все активные подписки с `end_date < текущая дата`
3. Для каждой подписки вызывается метод `markAsExpired()`, который:
   * Меняет статус на **expired**
   * Записывает действие в историю
4. Отправляются уведомления пользователям об истечении подписок

### 5.2 Уведомление о приближающемся истечении

**Процесс**:
1. Ежедневно запускается команда `NotifyExpiringSubscriptionsCommand`
2. Команда находит подписки, которые скоро истекут, с разными порогами для разных типов тарифов:
   * Демо-тариф: за 30 минут до окончания
   * Премиум 1 день: за 6 часов до окончания
   * Премиум 7 дней: за 1 день до окончания
   * Премиум 30 дней: за 3 дня до окончания
3. Для каждой подписки система отправляет уведомление пользователю
4. Уведомление содержит информацию о сроке истечения и предложение продлить подписку

## 6. API-интерфейсы

### 6.1 Пользовательские API

```
POST /api/v1/subscriptions                 # Создание заявки на подписку
GET /api/v1/subscriptions                  # Получение списка подписок пользователя
GET /api/v1/subscriptions/history          # Получение истории подписок
GET /api/v1/subscriptions/{id}             # Получение конкретной подписки
GET /api/v1/subscriptions/{id}/upgrades    # Получение доступных апгрейдов подписки
DELETE /api/v1/subscriptions/{id}          # Отмена подписки
```

### 6.2 Административные API

```
POST /api/v1/admin/subscriptions/activate             # Массовая активация подписок
POST /api/v1/admin/subscriptions                      # Создание подписки для пользователя
PATCH /api/v1/admin/subscriptions/{id}/change-tariff  # Изменение тарифа подписки
POST /api/v1/admin/subscriptions/{id}/extend          # Продление подписки
DELETE /api/v1/admin/subscriptions/{id}               # Отмена подписки
```

## 7. Структура базы данных

### 7.1 Основные таблицы

#### tariffs
| Поле | Тип | Описание |
|------|-----|----------|
| id | int | Уникальный идентификатор |
| name | string | Название тарифа |
| code | string | Код тарифа (demo, premium_1, premium_7, premium_30) |
| duration_hours | int | Длительность в часах |
| price | decimal | Стандартная цена |
| description | text | Описание тарифа |
| is_active | boolean | Активен ли тариф |

#### user_subscriptions
| Поле | Тип | Описание |
|------|-----|----------|
| id | int | Уникальный идентификатор |
| user_id | int | ID пользователя |
| tariff_id | int | ID тарифа |
| category_id | int | ID категории |
| location_id | int | ID локации |
| price_paid | decimal | Фактически уплаченная цена |
| start_date | datetime | Дата начала подписки |
| end_date | datetime | Дата окончания подписки |
| status | string | Статус (pending, active, expired, cancelled) |
| is_enabled | boolean | Включена ли подписка |
| payment_method | string | Метод оплаты |
| admin_notes | string | Заметки администратора |
| approved_by | int | ID администратора, утвердившего подписку |
| approved_at | datetime | Когда подписка была утверждена |

#### subscription_history
| Поле | Тип | Описание |
|------|-----|----------|
| id | int | Уникальный идентификатор |
| user_id | int | ID пользователя |
| subscription_id | int | ID подписки |
| action | string | Тип действия (created, activated, extended, expired, cancelled, enabled, disabled, tariff_changed) |
| tariff_name | string | Название тарифа на момент действия |
| category_name | string | Название категории на момент действия |
| location_name | string | Название локации на момент действия |
| price_paid | decimal | Уплаченная цена |
| action_date | datetime | Дата действия |
| notes | text | Примечания |

## 8. Рекомендации по эксплуатации системы

1. **Регулярное резервное копирование** данных о подписках и истории
2. **Мониторинг ошибок** при обработке подписок
3. **Анализ метрик использования** разных тарифов для оптимизации предложений
4. **Автоматизация процессов** проверки истечения и уведомлений
5. **Пользовательская обратная связь** для улучшения системы 