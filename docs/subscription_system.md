# Документация по системе управления подписками

## 1. Общее описание

Система управления подписками предназначена для работы с подписками пользователей на различные категории и локации. Позволяет создавать заявки на подписки, активировать подписки, продлевать их и отменять.

## 2. Жизненный цикл подписки

### 2.1 Статусы подписки

- **pending** - ожидает активации
- **active** - активна, пользователь имеет доступ к функциям
- **expired** - истекла, нуждается в продлении
- **cancelled** - отменена

### 2.2 Параметры подписки

- Тариф (определяет стоимость и длительность)
- Категория (тип объявлений)
- Локация (географический охват)
- Дата начала
- Дата окончания
- Стоимость
- Способ оплаты
- Уровень доступа

### 2.3 Создание подписки

#### 2.3.1 Создание демо-подписки

**Исходное состояние**:
* Пользователь зарегистрирован
* Пользователь не имеет активной демо-подписки
* Пользователь не использовал демо-подписку ранее

**Процесс**:
1. Пользователь выбирает демо-тариф через интерфейс
2. Система проверяет, что пользователь не использовал демо-подписку ранее (флаг is_trial_used)
3. Система создает подписку и активирует ее автоматически
4. Устанавливается флаг is_trial_used = true
5. Пользователь получает уведомление об активации демо-подписки

#### 2.3.2 Создание платной подписки

**Исходное состояние**:
* Пользователь зарегистрирован
* Пользователь может иметь или не иметь демо-подписку

**Процесс**:
1. Пользователь создает заявку на платную подписку через API:
   ```
   POST /api/v1/subscriptions
   {
     "tariff_id": 2,
     "category_id": 1,
     "location_id": 3
   }
   ```
2. Система создает подписку со статусом **pending**
3. Если у пользователя есть активная демо-подписка, она отменяется
4. Пользователь получает уведомление с инструкциями по оплате
5. Администратор получает уведомление о новой заявке

### 2.4 Активация подписки

**Исходное состояние**:
* Подписка имеет статус **pending**
* Администратор подтверждает оплату вне системы

**Процесс**:
1. Администратор активирует подписку через API:
   ```
   POST /api/v1/admin/subscriptions/activate
   {
     "subscription_id": 5,
     "payment_method": "card",
     "notes": "Подтверждено по чеку #12345",
     "duration_hours": 720
   }
   ```
2. Система:
   * Меняет статус с **pending** на **active**
   * Устанавливает дату начала и дату окончания
   * Записывает информацию о способе оплаты
   * Устанавливает флаг is_trial_used = true (если это первая платная подписка)
   * Отменяет все активные демо-подписки пользователя
3. Пользователь получает уведомление об активации подписки

### 2.5 Продление подписки

#### 2.5.1 Продление активной подписки

**Исходное состояние**:
* У пользователя есть подписка в статусе **active**
* Подписка еще не истекла

**Процесс**:
1. Пользователь запрашивает продление активной подписки
2. Система создает заявку на продление
3. Администратор проверяет оплату и использует API для продления:
   ```
   POST /api/v1/admin/subscriptions/extend
   {
     "subscription_id": 5,
     "payment_method": "card",
     "notes": "Продление активной подписки",
     "duration_hours": 720
   }
   ```
4. Система:
   * Сохраняет статус **active**
   * Увеличивает дату окончания на указанное количество часов
   * Записывает действие в историю с типом "extended"
5. Пользователь получает уведомление об успешном продлении

**Пример ответа API при успешном продлении**:
```json
{
  "code": 200,
  "status": "success",
  "message": "Подписка успешно продлена"
}
```

#### 2.5.2 Возобновление истекшей подписки

**Исходное состояние**:
* У пользователя есть подписка в статусе **expired**

**Процесс**:
1. Пользователь запрашивает продление истекшей подписки
2. Система создает заявку на продление
3. Администратор проверяет оплату и использует API для продления:
   ```
   POST /api/v1/admin/subscriptions/extend
   {
     "subscription_id": 5,
     "payment_method": "card",
     "notes": "Возобновление истекшей подписки",
     "duration_hours": 720
   }
   ```
4. Система:
   * Меняет статус с **expired** на **active**
   * Устанавливает `start_date = текущая дата`
   * Устанавливает `end_date = текущая дата + duration_hours`
   * Записывает действие в историю с типом "extended"
5. Пользователь получает уведомление об успешном возобновлении

#### 2.5.3 Создание заявки на продление

**Исходное состояние**:
* У пользователя есть активная или истекшая подписка

**Процесс**:
1. Пользователь запрашивает продление подписки через приложение или веб-интерфейс
2. Пользователь указывает ID подписки и тариф для продления (может совпадать с текущим или отличаться)
3. Система создает заявку на продление через API:
   ```
   POST /api/v1/subscriptions/extend-request
   {
     "subscription_id": 5,
     "tariff_id": 3,
     "notes": "Хочу продлить на месяц"
   }
   ```
4. Система:
   * Сохраняет запись о запросе в истории подписок
   * Отправляет уведомление администратору о новой заявке
5. Администратор обрабатывает заявку:
   * Проверяет оплату
   * При подтверждении оплаты, активирует продление через API

## 3. Тарифы

### 3.1 Типы тарифов

- **Демо** - бесплатный ограниченный доступ на короткий период (например, 3 часа)
- **Стандартный** - полный доступ на определенный период (например, 1, 7, 30 дней)
- **Премиум** - расширенный доступ с дополнительными функциями

### 3.2 Параметры тарифов

- Название
- Код (для программной идентификации)
- Длительность в часах
- Базовая стоимость
- Описание
- Активен/неактивен

## 4. Локации и категории

### 4.1 Локации

Локации представляют географические регионы, для которых действует подписка. Каждая локация имеет:
- Название города
- Название региона
- Координаты центра
- Географические границы (bounds)

### 4.2 Категории

Категории определяют тип объявлений, для которых действует подписка:
- Аренда. Жилая
- Продажа. Жилая
- Коммерческая недвижимость
- И т.д.

## 5. Уведомления

Система отправляет следующие типы уведомлений:
- Активация демо-подписки
- Активация платной подписки
- Создание заявки на подписку
- Скорое истечение подписки
- Истечение подписки
- Изменение тарифа
- Отмена подписки
- Продление подписки
- Уведомление администратору о новой заявке

## 6. API

### 6.1 Пользовательские API

```
POST /api/v1/subscriptions                      # Создание заявки на подписку
GET /api/v1/subscriptions                       # Получение списка подписок пользователя
GET /api/v1/subscriptions/history               # Получение истории подписок
GET /api/v1/subscriptions/{id}                  # Получение конкретной подписки
GET /api/v1/subscriptions/{id}/upgrades         # Получение доступных апгрейдов подписки
DELETE /api/v1/subscriptions/{id}               # Отмена подписки
POST /api/v1/subscriptions/extend-request       # Создание заявки на продление подписки
```

### 6.2 Административные API

```
POST /api/v1/admin/subscriptions/activate       # Активация подписки
POST /api/v1/admin/subscriptions/extend         # Продление подписки
POST /api/v1/admin/subscriptions/cancel         # Отмена подписки администратором
GET /api/v1/admin/subscriptions/pending         # Получение списка ожидающих подписок
GET /api/v1/admin/subscriptions                 # Получение списка всех подписок
```

#### Пример запроса на отмену подписки:
```
POST /api/v1/admin/subscriptions/cancel
{
  "subscription_id": 5,
  "reason": "Отменено по запросу пользователя"
}
```

## 7. История изменений

История изменений подписок сохраняется в таблице subscription_history с типами действий:
- created - создание заявки
- activated - активация
- extended - продление
- cancelled - отмена
- expired - истекла
- extend_requested - запрос на продление 